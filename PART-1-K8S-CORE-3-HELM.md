Kubernetes Helm
=================
4 часов, 1 ак. дня.

Prerequisites
=============

- [ ] RAM ≥ 8Gb
- [ ] [Пройденыне задание с тренига по Docker](#link-to-docker-part)
- [ ] [Пройденыне задание с тренига по K8S-CORE](#link-to-docker-part)
- [ ] [Развёрнутый кластер k8s на пару](#link-to-confluence)
- [ ] terminal
- [ ] kubectl cli


K8S Helm charts introduction
----------------------------

- [ ] Для чего придуман, предпосылки
- [ ] Предпосылки к появлению. Отсылки к kustomize.io.
- [ ] Что было "ДО"
- [ ] Версии Helm Charts
- [ ] Демо - объединение наработок по `app-butter` и `app-knife` для управления из одной "папки"
- [ ] Связь с multi service deploy и управление группой ресурсов как одной сущностью
- [ ] Сторонние Helm и их поддержка/обновление

## Hands-on practice quest #00: Установка и настройка

**Given** пары участников залогинены на `bastion` и выполнили задания предыдущей части
**When** участники исследуют утилиту helm и выполняют задание  
**Задание**: настроить окружение для работы с helm

```shell
which helm
sudo yum install helm

helm completion -h
helm repo list
helm search hub
helm search repo
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. Что выводят `helm repo list` и `helm search repo` и в чём отличие?
1. Что выводит `helm search hub` и почему?
1. **Доп задание**\*: куда и как нужно добавить результат работы команды `helm completion bash` чтобы сохранить автодополнение между shell сессиями? 

**Задание**: настроить внутренний репозиторий

```shell
# добавляем наши репозитории в helm
helm repo add -h
helm repo add ext-rbru-container-community-virtual-helm "https://artifactory.raiffeisen.ru/artifactory/ext-rbru-container-community-virtual-helm/" \
  --username "$USER"
helm repo update
helm repo list
helm search repo
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. Helm работает на нашей стороне или в кластере K8S?
1. Что лучше, ввод пароля интерактивно или с помощью флага `--password` при добавлении репозитория?
1. Видны ли в списке доступных чартов названия чартов? Попробуйте исправить, какие есть варианты?
1. **Доп задание**\*: как избежать добавления чувствительных к безопасности команд в историю команд? (bash_history)
1. **Доп задание**\*: Как поискать от имени другого пользователя? (например если у вас имеется привилегированный пользователь)

```shell
# * Дополнительное задание. Попробуйте установить helm chart из репозитория (например для filebeat)
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. Возникли ли какие-то сложности?
1. Объясните их природу
1. **Доп задание**\*: Найдите где Helm хранит свои настройки и посмотрите. Всё ли вам нравится?

Hands-on practice quest #01: создание Helm Chart
------------------------------------------------

**Given** пары участников залогинены на `bastion` и выполнили задания предыдущей части  
**When** участники пользуются утилитой helm для объединения K8S абстракций из первой части тренинга 
**Задание**: создать шаблон Helm chart с помощью консольной утилиты `helm`

```shell
# выбираем директорию где будем делать новый helm chart
mkdir -p handson/handson-helm-01/
cd handson/handson-helm-01/
helm create -h
helm create
cd <>
ls -la
cat Chart.yml
ls templates
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. знакомо ли вам то, что находит в директории templates?
1. почему в Chart.yml указано две версии? `version` и `appVersion`? 
1. на версию чего указывает `apiVersion`? Как с этим связан K8S? 
1. **Доп задание**\*: Посмотрите что находится в файлах в директории `templates` и `tests`. Найдите на что ссылаются переменные в этих файлах 

**Задание**: кастомизировать имя и версию Helm Chart нашего приложения `sandwich-fabric`

```shell
vi Chart.yaml
vi values.yaml
# WARN: сохраните или сделайте helm create в другой папке чтобы обращаться к стандартным шаблонам как к примерам
rm -rf templates/*.yaml

helm install -h
helm install <helm_chart_name> <helm_chart_dir>
helm list
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. какие трудности возникли при установке? Как бы вы их решали?
1. откуда `helm list` берёт список установленных helm charts?
1. что будет если установить несколько раз?

K8S Helm charts
---------------
- [ ] Структура HELM Charts
- [ ] команды helm и templates
- [ ] определение переменных для деплоя нашего приложения с помощью helm

Hands-on practice quest #02: структура и шаблон. Начинаем переносить deployment
-------------------------------------------------------------------------------
**Given** пары участников залогинены на `bastion` и создали шаблон helm chart  
**When** участники пользуются утилитой helm для объединения K8S абстракций из первой части тренинга  
**Задание**: Перенесите deployment `app-knife` и `app-butter` в helm шаблон 

```shell
ls -la templates
vi templates/deployment.yaml

helm install sandwich-fabric .
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. Какие возникли сложности? Объясните их?
1. как посмотреть на то что будет установленно без установки?
1. можно ли посмотреть только на конкретный шаблон?
1. **Доп задание**\*: Что будет если запустить helm install несколько раз с одним именем?
1. **Доп задание**\*: как версионировать helm charts?


K8S Helm charts шаблонизирование
--------------------------------

- [ ] Go-Template и его функции
- [ ] Helm CLI устройство
- [ ] Мета информация в шаблоне и использование примеров

Hands-on practice quest #03: функции шаблонизации и deployment
--------------------------------------------------------------
**Given** пары участников залогинены на `bastion` и развернули deployment sandwich-fabric с помщью helm  
**When** участники пользуются утилитой helm для объединения K8S абстракций из первой части тренинга  
**Задание**: добавьте путь к image repository в настройки helm и проверить получаемый шаблон

```shell
helm upgrade -h
helm template <> . -s templates/deployment.taml

# Добавим 
# image:
#   repository: '...'
#
vi values.yaml
# используем image.repository в шаблоне. * попробуйте сразу добавить значение по умолчанию на уровне шаблона
vi templates/deployments.yml
helm upgrade <> .
```

**Доп задание**\* Задание: добавьте автоматическое экранирование `image.repository` в шаблон 

**Given** пары участников залогинены на `bastion` и развернули deployment sandwich-fabric с помщью helm  
**When** участники пользуются утилитой helm для объединения K8S абстракций из первой части тренинга  
- [ ] Что будет если не прописывать в values.yaml `image.repository?` Попробуйте

K8S Helm charts как пакетный менеджер для K8S
---------------------------------------------

- [ ] Роль пакетных менеджеров для платформ
- [ ] Откуда растут ноги у Helm (Bitnami)
- [ ] HELM Chart как API для развёртывания комплексных решений в K8S

Hands-on practice quest #04: добавляем дефолтные значения в шаблон и мигрируем ingress
--------------------------------------------------------------------------------------
**Given** пары участников залогинены на `bastion` и развернули deployment sandwich-fabric с помощью helm  
**When** участники пользуются утилитой helm для объединения K8S абстракций из первой части тренинга  
**Задание**: Перенесите ingress с кастомизируемым правилом host. Добавьте путь к `ingress.host` в настройки helm

```shell
# Добавим в начало 
# ingress:
#   host: '...'
#
vi values.yaml
# попробуйте сразу экранировать кавычками значение host
vi templates/ingress.yml
helm upgrade <> .
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. Как проверить значение заэкранировалось и подставляется?
1. Получилось обновить приложение? Как были трудности?
1. **Доп задание**\* добавьте экранирование кавычками для значения `ingress.host` в шаблон
  
**Задание**: Перенесите service `app-knife` и `app-butter` в helm шаблон

```shell
vi values.yaml
vi templates/services.yml
helm upgrade <> .
```

**Then** участники делятся возникшими и решенными проблемами и отвечают на вопросы
1. проверьте работоспособность ingress
1. зачем экранировать значения?
1. что будет если в values два раза указать `ingress: ..` ?
1. **Доп задание**\*: сделайте для `image.repository` и дефолтное значение и экранирование в шаблоне deployment
1. **Доп задание**\*: перенесите `ConfigMaps` и `Secrets` из прошлых заданий в Helm

## K8S Helm Hub

- [ ] О Hub и как искать helm charts
- [ ] О релизном цикле helm charts
- [ ] Про multi service deployment 
  
Hands-on practice quest #4.1: задаём вопросы и доделываем то что не успели
--------------------------------------------------------------------------

**Then** участники подводят итоги и отвечают на контрольные вопросы
1. что будет если несколько раз запустить helm install? Безопасное ли это поведение?
1. какие версии у задеплоенных helm chart и приложения?
1. кто обновляет версии?
1. где хранятся эти версии?
1. как их посмотреть?
1. как сделать дефолтные значения для переменных шаблона?
1. как откатить helm?
1. как `helm` связан с `kubectl`?
1. можно ли и как с помощью Helm создать namespace?

K8S Base Homework
-----------------

**Задание**: Попробуйте попрактиковаться и применить полученные навыки для переноса оставшихся ресурсов в helm chart
  - ConfigMaps 
  - Secrets
  - LimitRanges
  - CronJobs

**Доп задание**\*: Самостоятельно разберитесь с Helm test и интегрируйте тест из CronJob в Helm chart